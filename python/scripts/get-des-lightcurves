#!/usr/bin/env python
"""Get light curves of supernova candidates from DES database.
"""
from sys import stdout
from argparse import ArgumentParser
try:
    import cx_Oracle
except:
    print ("This script requires the cx_Oracle python package. "
           "Follow instructions at\n"
           "https://github.com/esheldon/desdb#dependencies\n"
           "exiting...")
    exit()
try:
    import desdb
except:
    print ("This script requires the desdb package:\n"
           "https://github.com/esheldon/desdb\n"
           "exiting...")
    exit()
try:
    import dessn
except:
    print "The dessn module must be installed or in $PYTHONPATH."
    exit()


parser = ArgumentParser(description=__doc__)
parser.add_argument('dir', help='Existing target directory for files.')

def main():
    args = parser.parse_args()
    if not os.path.exists(args.dir):
        print "dir must be an existing directory"
        exit()

    conn = desdb.connect()

    q = """
        SELECT DISTINCT
            a.snid, b.ra, b.dec, b.cand_type, b.cand_desc
        FROM
            snscan a, sncand b
        WHERE
            a.snid=b.snid
            AND b.snfake_id=0
            AND a.categorytype like '%SN%'
        ORDER BY
            a.snid
        """
    cands = conn.quick(q)
    ncands = len(cands)

    print '',
    for i, cand in enumerate(cands):
        print '\rsnid={:8d} ({:6d}/{:6d})'.format(cand['snid'], i, ncands),
        stdout.flush()

        q = """
            SELECT
                e.band, e.mjd_obs, f.flux, f.flux_err
            FROM
                exposure e, snforce f, image i
            WHERE
                f.sncand_id={:d}
                AND f.status<16
                AND i.id=f.image_id
                AND e.id=i.exposureid
            ORDER BY
                e.mjd_obs
            """.format(cand['snid'])
        data = conn.quick(q, array=True)

        # Add some metadata to cand to conform to SNANA requirements.
        cand['survey'] = 'DES'
        cand['filters'] = 'griz'
        cand['decl'] = cand['dec']
        del cand['dec']
        cand['redshift_final'] = '999. +- 99.'
        cand['mwebv'] = 0.

        # Add zeropoint information to data.
        snana_data = {'mjd': data['mjd_obs'],
                      'flt': data['band'],
                      'fluxcal': data['flux'],
                      'fluxcalerr': data['flux_err'],
                      'zpt': len(data) * [31.4]}
        snana_data = dessn.dict_to_array(snana_data)
        fname = '{}/des{:07d}.dat'.format(args.dir, cand['snid'])
        dessn.writelc(cand, snana_data, fname, fmt='snana')

if __name__ == '__main__':
    main()
